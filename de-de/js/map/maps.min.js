
mcOptions={styles:clusterStyles,gridSize:100,ignoreHidden:true,maxZoom:17}
var opt={nav:'#map-navigation',badgeDirectory:'img/map/badges',badgeDirectoryBig:'img/map/badges/large',mapContainer:'#map-container',gridContainer:'#grid-container',infowindowContainer:'#infowindow-container',infowindowClose:'.close-infowindow',resetMap:'.reset_map',countryClass:'.country',regionClass:'.region',cityClass:'.city',levelClass:'.level',dimmed:'dimmedNav'}
function arrayUnique(a)
{return a.reduce(function(p,c){if(p.indexOf(c)<0)p.push(c);return p;},[]);}
function compare(a,b)
{if(a.level<b.level)
return-1;if(a.level>b.level)
return 1;return 0;}
function outputPopup(dataPartner,i)
{if(i)
{dataPartner=dataPartner.filter(function(el){return i.indexOf(el.id)>-1;});dataPartner=dataPartner[0];}
var contentString='';contentString+='<div class="infowindow" >'+'<span class="close-infowindow">x</span>'+'<img class="infowindow-badge" src="'+opt.badgeDirectoryBig+'/'+dataPartner.level+'.png" alt="" />'+'<h1>'+dataPartner.company+'</h1>'+'<p><strong>Location:</strong> '+dataPartner.city+'</p>';if(dataPartner.contact){contentString+='<p><strong>Contact:</strong> '+dataPartner.contact+'</p>';}
if(dataPartner.email){contentString+='<p><strong>Email:</strong> <a href="mailto:'+dataPartner.email+'">'+dataPartner.email+'</a></p>';}
if(dataPartner.website){contentString+='<p><strong>Website:</strong> '+dataPartner.website+'</p>';}
if(dataPartner.address){contentString+='<p><strong>Address:</strong> '+dataPartner.address+'</p>';}
if(dataPartner.description){contentString+='<p>'+dataPartner.description+'</p>';}
contentString+='</div>';return contentString;}
function closeAllInfoWindows(infowindow)
{for(var i=0;i<infowindow.length;i++)
{infowindow[i].close();}}
function partnerLevelCalculator(markers,numStyles)
{var index=Math.min.apply(Math,markers.map(function(o){return o.partnerLevel;}));var count=markers.length;return{index:index,text:''}}
function removeMarkers(markers)
{for(var i=0;i<markers.length;i++)
{markers[i].setVisible(false);}}
function replaceMarkers(markers)
{for(var i=0;i<markers.length;i++)
{markers[i].setVisible(true);}}
function generateInputs(destinationType,filter,filterOptions)
{var destInputs='';var uniqueDest=[];for(var i=0;i<filter.length;i++)
{uniqueDest.push(filter[i][destinationType]);}
uniqueDest=arrayUnique(uniqueDest);for(var i=0;i<uniqueDest.length;i++)
{switch(uniqueDest[i])
{case 1:levelName='Platinum';break;case 2:levelName='Gold';break;case 3:levelName='Silver';break;case 4:levelName='Bronze';break;default:levelName=uniqueDest[i];}
if(filterOptions[destinationType].indexOf(String(uniqueDest[i]))>-1){checked=' checked="checked" ';}else{checked='';}
destInputs+='<li><label for="'+destinationType+'_'+uniqueDest[i]+'_'+i+'">'+'<input type="checkbox" '+checked+' value="'+destinationType+':'+uniqueDest[i]+'" id="'+destinationType+'_'+uniqueDest[i]+'_'+i+'" /> '+levelName+'</label></li>';}
$('.'+destinationType+'').html(destInputs);}
function jump_to_filter(filterOptions,markers,map,markerCluster)
{var country=[],region=[],city=[],level=[],view=[];$(opt.nav+' input').each(function()
{if($(this).is(':checked'))
{filterOptions=$(this).val().split(':');if(filterOptions[0]=='country'){country.push(filterOptions[1]);}
if(filterOptions[0]=='region'){region.push(filterOptions[1]);}
if(filterOptions[0]=='city'){city.push(filterOptions[1]);}
if(filterOptions[0]=='level'){level.push(filterOptions[1]);}
if(filterOptions[0]=='view'){view.push(filterOptions[1]);}}});if(region.length<1){city=[];$(opt.cityClass).empty();}
var filterOptions={'country':country,'region':region,'city':city,'level':level,'view':view}
var oldmarkers=markers;removeMarkers(markers);var filter=partners.partner;if(filterOptions.country.length>0)
{filter=partners.partner.filter(function(el){return filterOptions.country.indexOf(el.country)>-1;});generateInputs('region',filter,filterOptions);generateInputs('level',filter,filterOptions);}
if(filterOptions.region.length>0)
{filter=filter.filter(function(el){return filterOptions.region.indexOf(el.region)>-1;});markers=markers.filter(function(el){return filterOptions.region.indexOf(String(el.partnerRegion))>-1;});generateInputs('city',filter,filterOptions);generateInputs('level',filter,filterOptions);}
if(filterOptions.city.length>0)
{filter=filter.filter(function(el){return filterOptions.city.indexOf(el.city)>-1;});markers=markers.filter(function(el){return filterOptions.city.indexOf(String(el.partnerCity))>-1;});generateInputs('level',filter,filterOptions);}
if(filterOptions.level.length>0)
{filter=filter.filter(function(el){return filterOptions.level.indexOf(String(el.level))>-1;});markers=markers.filter(function(el){return filterOptions.level.indexOf(String(el.partnerLevel))>-1;});}
if(filter.length<1)
{var Errormessage=true;}else{var Errormessage=false;}
replaceMarkers(markers);filter.sort(compare);if(view[0]=='map_view')
{if(Errormessage){alert('No results');}else{var latlongs=[];for(var i=0;i<filter.length;i++)
{latlongs[i]=[filter[i].latitude,filter[i].longitude];}
var bounds=new google.maps.LatLngBounds();for(i=0;i<latlongs.length;i++)
{var position=new google.maps.LatLng(latlongs[i][0],latlongs[i][1]);bounds.extend(position);map.setZoom(map.getZoom()-1);}
map.fitBounds(bounds);if(map.getZoom()>17)
{map.setZoom(17);}}}else
if(view[0]=='grid_view'&&!Errormessage)
{$(opt.gridContainer).unbind();$(opt.gridContainer).on('click','.grid_view_more_link',function(){var i=$(this).attr('data-infowindow');$(opt.infowindowContainer).html(outputPopup(filter,i)).show();$(opt.gridContainer+' ul').fadeTo('fast',0.3);$(opt.infowindowClose).show();});$(opt.gridContainer).on('click',opt.infowindowClose,function(){$(opt.infowindowContainer).empty().hide();$(opt.gridContainer+' ul').fadeTo('fast',1);$(opt.infowindowClose).hide();});if(Errormessage){alert('No results');}else{var output='';for(var i=0;i<filter.length;i++)
{output+='<li class="col-sm-4 "><img class="grid_view_level_badge" src="'+opt.badgeDirectory+'/'+filter[i].level+'.png" alt="" />'+'<p class="grid_view_company_name">'+filter[i].company+'</p>'+'<p class="grid_view_city">'+filter[i].city+'</p>'+'<p class="grid_view_more_link" data-infowindow="'+filter[i].id+'">Find out more &gt;</p></li>';}
$(opt.gridContainer+' ul').html(output);}}
$(opt.nav+' ol').each(function(){if($(this).find('li').length<1)
{$(this).parents('li').addClass(opt.dimmed);}
else
{$(this).parents('li').removeClass(opt.dimmed);}});}
var infowindow=null;function initialize()
{var center=new google.maps.LatLng(54.97403,-1.59217);var map=new google.maps.Map(document.getElementById('map'),{zoom:7,center:center,scrollwheel:false,draggable:false,mapTypeId:google.maps.MapTypeId.ROADMAP});var markers=[];var infowindow=[];for(var i=0;i<partners.partner.length;i++)
{var dataPartner=partners.partner[i];var image=singleStyles[dataPartner.level-1];var latLng=new google.maps.LatLng(dataPartner.latitude,dataPartner.longitude);var marker=new google.maps.Marker({position:latLng,partnerLevel:dataPartner.level,partnerCity:dataPartner.city,partnerRegion:dataPartner.region,icon:image});markers.push(marker);infowindow.push(new google.maps.InfoWindow({content:outputPopup(dataPartner)}));google.maps.event.addListener(marker,'click',function(key){return function()
{infowindow[key].open(map,this);map.setCenter(this.getPosition());}}(i));}
var markerCluster=new MarkerClusterer(map,markers,mcOptions);markerCluster.setCalculator(partnerLevelCalculator);$(opt.nav).on('change','input',function()
{if($(this).val().split(':')[0]=='country')
{$(opt.regionClass+' input:checkbox').prop("checked",false);$(opt.cityClass+' input:checkbox').prop("checked",false);$(opt.levelClass+' input:checkbox').prop("checked",false);}
if($(this).val().split(':')[1]=='grid_view')
{$(opt.mapContainer).hide();$(opt.gridContainer).show();}
if($(this).val().split(':')[1]=='map_view')
{closeAllInfoWindows(infowindow);$(opt.gridContainer).hide();$(opt.mapContainer).show();}
var filterOptions='';jump_to_filter(filterOptions,markers,map,markerCluster);});$(opt.nav).on('click',opt.resetMap,function()
{if($("input:checkbox").is(':checked'))
{$("input:checkbox").prop("checked",false);var t={'country':['UK'],'region':['blank'],'city':['blank'],'level':['blank'],'view':['map_view']};jump_to_filter(t,markers,map,markerCluster);}});var t={'country':['UK'],'region':['blank'],'city':['blank'],'level':['blank'],'view':['map_view']};$("#map_view").prop("checked",true);$("#cb-UK").prop("checked",true);jump_to_filter(t,markers,map,markerCluster);}
google.maps.event.addDomListener(window,'load',initialize);$(document).ready(function(){$("input:checkbox").prop("checked",false);$("input:radio").prop("checked",false);$(opt.gridContainer).hide();});